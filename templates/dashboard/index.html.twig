{% extends 'base.html.twig' %}

{% block title %}Tableau de bord — StockManager Pro{% endblock %}

{% block body %}
{# ─── Page Header ─── #}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold mb-1" style="color:var(--text-primary)">Tableau de bord</h4>
        <p class="mb-0" style="font-size:0.875rem;color:var(--text-muted)">Vue d'ensemble de votre inventaire</p>
    </div>
    <a href="{{ path('product_new') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i> Nouveau produit
    </a>
</div>

{# ─── KPI Stat Cards ─── #}
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="stat-icon bg-primary-light"><i class="bi bi-box-fill"></i></div>
                    <span class="stat-trend stat-trend-up"><i class="bi bi-arrow-up-short"></i> Actif</span>
                </div>
                <div class="stat-value">{{ totalProducts }}</div>
                <div class="stat-label">Produits</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="stat-icon bg-success-light"><i class="bi bi-tags-fill"></i></div>
                    <span class="stat-trend stat-trend-up"><i class="bi bi-arrow-up-short"></i> Actif</span>
                </div>
                <div class="stat-value">{{ totalCategories }}</div>
                <div class="stat-label">Catégories</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="stat-icon bg-info-light"><i class="bi bi-truck"></i></div>
                    <span class="stat-trend stat-trend-up"><i class="bi bi-arrow-up-short"></i> Actif</span>
                </div>
                <div class="stat-value">{{ totalFournisseurs }}</div>
                <div class="stat-label">Fournisseurs</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="stat-icon bg-warning-light"><i class="bi bi-cash-stack"></i></div>
                    {% if lowStockProducts|length > 0 %}
                        <span class="stat-trend stat-trend-down"><i class="bi bi-exclamation-triangle"></i> {{ lowStockProducts|length }} alerte{{ lowStockProducts|length > 1 ? 's' : '' }}</span>
                    {% else %}
                        <span class="stat-trend stat-trend-up"><i class="bi bi-check"></i> OK</span>
                    {% endif %}
                </div>
                <div class="stat-value">{{ totalStockValue|number_format(0, ',', ' ') }} DT</div>
                <div class="stat-label">Valeur du stock</div>
            </div>
        </div>
    </div>
</div>

{# ─── Charts Row ─── #}
<div class="row g-4 mb-4">
    {# Donut Chart - Products by Category #}
    <div class="col-lg-4">
        <div class="chart-card h-100">
            <h6><i class="bi bi-pie-chart-fill me-2" style="color:var(--primary)"></i>Répartition par catégorie</h6>
            <div class="d-flex align-items-center justify-content-center" style="height:260px">
                <canvas id="categoryDonutChart"></canvas>
            </div>
        </div>
    </div>

    {# Bar Chart - Stock Levels #}
    <div class="col-lg-4">
        <div class="chart-card h-100">
            <h6><i class="bi bi-bar-chart-fill me-2" style="color:var(--primary)"></i>Niveaux de stock</h6>
            <div style="height:260px">
                <canvas id="stockBarChart"></canvas>
            </div>
        </div>
    </div>

    {# Line Chart - Stock Value Trend #}
    <div class="col-lg-4">
        <div class="chart-card h-100">
            <h6><i class="bi bi-graph-up me-2" style="color:var(--primary)"></i>Aperçu des prix</h6>
            <div style="height:260px">
                <canvas id="priceTrendChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    {# ─── Low Stock Alerts ─── #}
    <div class="col-lg-6">
        <div class="table-card">
            <div class="card-header">
                <h5><i class="bi bi-exclamation-triangle-fill me-2" style="color:var(--warning)"></i>Alertes stock bas (≤ {{ lowStockThreshold }})</h5>
                <span class="badge-stock-low">{{ lowStockProducts|length }}</span>
            </div>
            <div class="card-body p-0">
                {% if lowStockProducts|length > 0 %}
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Stock</th>
                            <th>Prix</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in lowStockProducts %}
                        <tr>
                            <td class="fw-semibold">{{ product.libelle }}</td>
                            <td>
                                {% if product.stock == 0 %}
                                    <span class="badge-stock-out">Rupture</span>
                                {% else %}
                                    <span class="badge-stock-low">{{ product.stock }}</span>
                                {% endif %}
                            </td>
                            <td>{{ product.price|number_format(2, ',', ' ') }} DT</td>
                            <td>
                                <a href="{{ path('product_edit', {id: product.id}) }}" class="btn-icon" title="Modifier">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-4" style="color:var(--text-muted)">
                    <i class="bi bi-check-circle" style="font-size:2rem;color:var(--success)"></i>
                    <p class="mt-2 mb-0">Tous les stocks sont suffisants</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {# ─── Recent Products ─── #}
    <div class="col-lg-6">
        <div class="table-card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history me-2" style="color:var(--primary)"></i>Produits récents</h5>
                <a href="{{ path('product_index') }}" class="btn btn-sm btn-outline-primary">Voir tout</a>
            </div>
            <div class="card-body p-0">
                {% if recentProducts|length > 0 %}
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Produit</th>
                            <th>Catégorie</th>
                            <th>Prix</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in recentProducts %}
                        <tr>
                            <td>
                                {% if product.image %}
                                    <img src="{{ asset('uploads/' ~ product.image) }}" class="img-thumb" alt="{{ product.libelle }}">
                                {% else %}
                                    <div class="img-placeholder"><i class="bi bi-image"></i></div>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ path('product_show', {id: product.id}) }}" class="text-decoration-none fw-semibold" style="color:var(--text-primary)">{{ product.libelle }}</a>
                            </td>
                            <td>
                                {% if product.category %}
                                    <span class="badge-purple">{{ product.category.nom }}</span>
                                {% else %}
                                    <span style="color:var(--text-muted)">—</span>
                                {% endif %}
                            </td>
                            <td class="fw-semibold">{{ product.price|number_format(2, ',', ' ') }} DT</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center py-4" style="color:var(--text-muted)">
                    <i class="bi bi-inbox" style="font-size:2rem"></i>
                    <p class="mt-2 mb-0">Aucun produit ajouté</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const purple = '#7c3aed';
    const purpleLight = '#a78bfa';
    const chartColors = ['#7c3aed','#06b6d4','#10b981','#f59e0b','#ef4444','#ec4899','#8b5cf6','#14b8a6'];

    Chart.defaults.font.family = "'Inter', 'Segoe UI', sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#6b7280';

    // ─── Donut Chart: Products by Category ───
    const categoryData = {
        labels: [{% for item in productsByCategory %}'{{ item.category ?? "Sans catégorie" }}'{{ not loop.last ? ',' }}{% endfor %}],
        datasets: [{
            data: [{% for item in productsByCategory %}{{ item.count }}{{ not loop.last ? ',' }}{% endfor %}],
            backgroundColor: chartColors.slice(0, {{ productsByCategory|length }}),
            borderWidth: 0,
            hoverOffset: 8,
            borderRadius: 4,
        }]
    };

    new Chart(document.getElementById('categoryDonutChart'), {
        type: 'doughnut',
        data: categoryData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '68%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10, boxHeight: 10,
                        borderRadius: 5, useBorderRadius: true,
                        padding: 12, font: { size: 11 }
                    }
                }
            }
        }
    });

    // ─── Bar Chart: Stock Levels by Category ───
    const stockData = {
        labels: [{% for item in productsByCategory %}'{{ item.category ?? "Sans catégorie" }}'{{ not loop.last ? ',' }}{% endfor %}],
        datasets: [{
            label: 'Produits',
            data: [{% for item in productsByCategory %}{{ item.count }}{{ not loop.last ? ',' }}{% endfor %}],
            backgroundColor: chartColors.map(c => c + '33'),
            borderColor: chartColors,
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
        }]
    };

    new Chart(document.getElementById('stockBarChart'), {
        type: 'bar',
        data: stockData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 10 } }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: '#f3f4f6' },
                    ticks: { stepSize: 1, font: { size: 10 } }
                }
            }
        }
    });

    // ─── Line Chart: Recent Product Prices ───
    const recentPrices = {
        labels: [{% for product in recentProducts %}'{{ product.libelle|slice(0,12) }}'{{ not loop.last ? ',' }}{% endfor %}],
        datasets: [{
            label: 'Prix (DT)',
            data: [{% for product in recentProducts %}{{ product.price }}{{ not loop.last ? ',' }}{% endfor %}],
            borderColor: purple,
            backgroundColor: 'rgba(124, 58, 237, 0.08)',
            borderWidth: 2.5,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#fff',
            pointBorderColor: purple,
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
        }]
    };

    new Chart(document.getElementById('priceTrendChart'), {
        type: 'line',
        data: recentPrices,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 10 } }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: '#f3f4f6' },
                    ticks: {
                        font: { size: 10 },
                        callback: function(v) { return v + ' DT'; }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
